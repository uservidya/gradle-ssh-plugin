apply plugin: 'ssh'

ssh {
    config(StrictHostKeyChecking: 'no')
}

remotes {
    localhost {
        role 'testServers'
        host = 'localhost'
        user = System.properties['user.name']
        identity = file("${System.properties['user.home']}/.ssh/id_rsa")
    }
}


task executeCommand(type: SshTask) {
    session(remotes.localhost) {
        execute "touch '${ext.tempFile.path}'"
    }
}

feature('executing a command') {
    given {
        whenTask.ext.tempFile = file("${buildDir}/${UUID.randomUUID()}")
        assert !whenTask.ext.tempFile.exists()
    }
    when(tasks.executeCommand)
    then {
        assert whenTask.ext.tempFile.exists()
        assert whenTask.ext.tempFile.delete()
    }
}


task executeCommandByRole(type: SshTask) {
    session(remotes.role('testServers')) {
        execute "touch '${ext.tempFile.path}'"
    }
}

feature('filter hosts by role') {
    given {
        whenTask.ext.tempFile = file("${buildDir}/${UUID.randomUUID()}")
        assert !whenTask.ext.tempFile.exists()
    }
    when(tasks.executeCommandByRole)
    then {
        assert whenTask.ext.tempFile.exists()
        assert whenTask.ext.tempFile.delete()
    }
}


task obtainValue(type: SshTask) {
    session(remotes.localhost) {
        ext.z = execute("expr $x + $y")
    }
}

feature('obtaining a value from the remote command') {
    given {
        whenTask.ext.x = (Math.random() * 100) as int
        whenTask.ext.y = (Math.random() * 100) as int
    }
    when(tasks.obtainValue)
    then {
        assert (whenTask.ext.z as int) == (whenTask.ext.x + whenTask.ext.y)
    }
}
